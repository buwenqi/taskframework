<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="ThemeBucket">
    <link rel="shortcut icon" href="#" type="image/png">

    <title>Task Manager</title>
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/style-responsive.css" rel="stylesheet">
    <link href="css/bootstrap-select.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->

    <script src="js/html5shiv.js"></script>
    <script src="js/respond.min.js"></script>

    <script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
    <script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <!-- bootstrap table   -->
    <link href="//cdn.bootcss.com/bootstrap-table/1.11.0/bootstrap-table.min.css" rel="stylesheet">
    <script src="//cdn.bootcss.com/bootstrap-table/1.11.0/bootstrap-table-locale-all.js"></script>
    <script src="//cdn.bootcss.com/bootstrap-table/1.11.0/bootstrap-table.min.js"></script>


</head>

<body class="sticky-header">

<section>
    <!-- left side start-->
    <div class="left-side sticky-left-side">

        <!--logo and iconic logo start-->
        <div class="logo">
            <a href="index.html"><img src="images/logo.png" alt=""></a>
        </div>

        <div class="logo-icon text-center">
            <a href="index.html"><img src="images/logo_icon.png" alt=""></a>
        </div>
        <!--logo and iconic logo end-->


        <div class="left-side-inner">

            <!-- visible to small devices only -->
            <!--sidebar nav start-->
            <ul class="nav nav-pills nav-stacked custom-nav">
                <li><a href="index.html"><i class="fa fa-laptop"></i><span>任务管理</span></a> </li>
                <li><a href="executor.html"><i class="fa fa-laptop"></i> <span>执行器管理</span></a></li>
            </ul>
            <!--sidebar nav end-->

        </div>
    </div>
    <!-- left side end-->

    <!-- main content start-->
    <div class="main-content" >

        <!-- header section start-->
        <div class="header-section">

            <!--toggle button start-->
            <a class="toggle-btn"><i class="fa fa-bars"></i></a>
            <!--toggle button end-->

        </div>
        <!-- header section end-->

        <!-- page heading start-->
        <div class="page-heading">
            <h2>任务管理</h2>
        </div>
        <!-- page heading end-->

        <!--body wrapper start-->
        <div class="wrapper">
            <section class="panel">
                <div id="toolbar" class="btn-group">
                    <button id="add" class="btn btn-default" data-toggle="modal" data-target="#addJobModal">
                        <i class="glyphicon glyphicon-plus"></i>新增
                    </button>
                </div>
                <div class="panel-body">
                    <table id="table" class="table table-striped table-hover table-bordered"
                           data-toolbar="#toolbar"
                           data-search="true"
                           data-show-refresh="true"
                           data-show-columns="true"
                           data-show-toggle="true"></table>
                </div>
            </section>
        </div>

        <!--body wrapper end-->

        <!--footer section start-->
        <footer class="sticky-footer">
            2018 &copy; taskframework
        </footer>
        <!--footer section end-->


    </div>
    <!-- main content end-->
</section>

<!--模态框 -->
<div class="modal fade" id="addJobModal" tabindex="-1" role="dialog" style="display:none;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">×</a>
                <h4>添加任务</h4>
            </div>
            <div class="modal-body">
                <form id="addJobForm" class="form-horizontal" role="form" >
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="job_name">任务名称</label>
                        <div class="col-sm-4">
                            <input name="jobName" class="form-control" id="job_name" type="text" placeholder="请输入任务名称"/>
                        </div>
                        <label class="col-sm-2 control-label" for="job_group">任务组</label>
                        <div class="col-sm-4">
                            <input name="jobGroup" class="form-control" id="job_group" type="text" placeholder="请输入任务组"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="job_cron">Cron</label>
                        <div class="col-sm-4">
                            <input name="jobCron" class="form-control" id="job_cron" type="text" placeholder="请输入周期"/>
                        </div>
                        <label class="col-sm-2 control-label" for="job_desc">任务描述</label>
                        <div class="col-sm-4">
                            <input name="jobDesc" class="form-control" id="job_desc" type="text" placeholder="请输入任务描述"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="author">负责人</label>
                        <div class="col-sm-4">
                            <input name="author" class="form-control" id="author" type="text" placeholder="请输入负责人"/>
                        </div>
                        <label class="col-sm-2 control-label" for="email">报警邮件</label>
                        <div class="col-sm-4">
                            <input name="email" class="form-control" id="email" type="text" placeholder="请输入报警邮件"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="jobFile">文件</label>
                        <div class="col-sm-4">
                            <input name="jobFilePath" id="jobFile" type="text" class="form-control" placeholder="请输入文件路径"/>
                        </div>
                        <label class="col-sm-2 control-label" for="job_filetype">文件类型</label>
                        <div class="col-sm-4">
                            <select name="jobFileType" id="job_filetype" class="form-control">
                                <option>java</option>
                                <option>python</option>
                                <option>shell</option>
                                <option>bat</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="executor">执行器</label>
                        <div class="col-sm-4">
                            <select name="executorInfo.id" id="executor" class="form-control selectpicker">
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="addBtn" class="btn btn-default" onclick="addJob()">确定</button>
                <button type="button" id="reset" class="btn" data-dismiss="modal" onclick="resetAddModal()">取消</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editJobModal" tabindex="-1" role="dialog" style="display:none;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">×</a>
                <h4>修改任务</h4>
            </div>
            <div class="modal-body">
                <form id="editJobForm" class="form-horizontal" role="form" >
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="editJobName">任务名称</label>
                        <div class="col-sm-4">
                            <input type="hidden" id="id" name="id"/>
                            <input name="jobName" class="form-control" id="editJobName" type="text" placeholder="请输入任务名称"/>
                        </div>
                        <label class="col-sm-2 control-label" for="editJobGroup">任务组</label>
                        <div class="col-sm-4">
                        <input name="jobGroup" class="form-control" id="editJobGroup" type="text" placeholder="请输入任务组"/>
                    </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label" for="editJobCron">Cron</label>
                <div class="col-sm-4">
                    <input name="jobCron" class="form-control" id="editJobCron" type="text" placeholder="请输入周期"/>
                </div>
                <label class="col-sm-2 control-label" for="editJobDesc">任务描述</label>
                <div class="col-sm-4">
                    <input name="jobDesc" class="form-control" id="editJobDesc" type="text" placeholder="请输入任务描述"/>
                </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="editAuthor">负责人</label>
                        <div class="col-sm-4">
                            <input name="author" class="form-control" id="editAuthor" type="text" placeholder="请输入负责人"/>
                        </div>
                        <label class="col-sm-2 control-label" for="editEmail">报警邮件</label>
                        <div class="col-sm-4">
                            <input name="email" class="form-control" id="editEmail" type="text" placeholder="请输入报警邮件"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="editJobFilePath">文件</label>
                        <div class="col-sm-4">
                            <input type="text" id="editJobFilePath" name="jobFilePath" class="form-control" placeholder="请输入文件路径"/>
                        </div>
                        <label class="col-sm-2 control-label" for="editJobFileType">文件类型</label>
                        <div class="col-sm-4">
                            <select name="jobFileType" id="editJobFileType" class="form-control">
                                <option>java</option>
                                <option>python</option>
                                <option>shell</option>
                                <option>bat</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="executor">执行器</label>
                        <div class="col-sm-4">
                            <select name="ExecutorInfo.id" id="editExecutor" class="form-control selectpicker">
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="editBtn" class="btn btn-default" onclick="updateJob()">确定</button>
                <a href="#" class="btn" data-dismiss="modal">取消</a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="showJob" tabindex="-1" role="dialog" style="display:none;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">×</a>
                <h4>任务详细信息</h4>
            </div>
            <div class="modal-body">
                <form id="jobDesc" class="form-horizontal" role="form" >
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="showJobName">任务名称</label>
                        <div class="col-sm-4">
                            <input name="jobName" class="form-control" id="showJobName" type="text" readonly/>
                        </div>
                        <label class="col-sm-2 control-label" for="showJobGroup">任务组</label>
                        <div class="col-sm-4">
                            <input name="jobGroup" class="form-control" id="showJobGroup" type="text" readonly/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="showJobCron">Cron</label>
                        <div class="col-sm-4">
                            <input name="jobCron" class="form-control" id="showJobCron" type="text" readonly/>
                        </div>
                        <label class="col-sm-2 control-label" for="showJobDesc">任务描述</label>
                        <div class="col-sm-4">
                            <input name="jobDesc" class="form-control" id="showJobDesc" type="text" readonly/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="showAuthor">负责人</label>
                        <div class="col-sm-4">
                            <input name="author" class="form-control" id="showAuthor" type="text" readonly/>
                        </div>
                        <label class="col-sm-2 control-label" for="showEmail">报警邮件</label>
                        <div class="col-sm-4">
                            <input name="email" class="form-control" id="showEmail" type="text" readonly/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="showJobFilePath">文件</label>
                        <div class="col-sm-4">
                            <input name="jobFilePath" id="showJobFilePath" type="text" class="form-control" readonly/>
                        </div>
                        <label class="col-sm-2 control-label" for="showJobFileType">文件类型</label>
                        <div class="col-sm-4">
                            <input name="jobFileType" id="showJobFileType" type="text" class="form-control" readonly/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="showAddTime">加入时间</label>
                        <div class="col-sm-4">
                            <input name="addTime" id="showAddTime" type="text" class="form-control" readonly/>
                        </div>
                        <label class="col-sm-2 control-label" for="showUpdateTime">更新时间</label>
                        <div class="col-sm-4">
                            <input name="updateTime" id="showUpdateTime" type="text" class="form-control" readonly/>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">确定</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="tip" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3>提示</h3>
            </div>
            <div class="modal-body" align="center">
                <h4 id="tipContent">添加成功</h4>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">确定</button>
            </div>
        </div>
    </div>
</div>
<!--模态框 结束-->

<script type="text/javascript">

        $(function(){
            $.ajax({
                url: '/executor/getOption',
                dataType: "json",
                success: function(data){

                    for(var i=0;i<data.length;i++){
                        $('.selectpicker').append("<option value="+data[i].id+">"+data[i].ipAddress+":"+data[i].port+"</option>");
                    }
                    $('#executor').selectpicker('refresh');
                    $('#executor').selectpicker('render');
                    $('#editExecutor').selectpicker('refresh');
                    $('#editExecutor').selectpicker('render');
                }
            });
        });

        $('#table').bootstrapTable({
            method:"POST",
			contentType: "application/x-www-form-urlencoded",
            url: '/job/jobInfo',
            uniqueId:"id",
            pagination:true,
            pageNumber: 1,
            pageSize: 10,
            sidePagination: "server",
            queryParams:function queryParam(params){
                var param = {
                limit: this.limit,
                offset: this.offset,
                pageNumber: this.pageNumber,
                pageSize: this.pageSize
                };
                return param;
        },
            columns: [{
                field: 'id',
                visible: false
            },{
                field: 'jobName',
                title: '任务名称',
            },{
                field: 'jobGroup',
                visible: false
            },{
                field: 'jobCron',
                title: 'Cron'
            },{
                field: 'jobDesc',
                visible: false
            },{
                field: 'jobFilePath',
                visible: false
            },{
                field: 'jobFileType',
                visible: false
            },{
                field: 'author',
                title: '负责人'
            },{
                field: 'email',
                visible: false
            },{
                field: 'addTime',
                visible: false
            },{
                field: 'updateTime',
                visible: false
            },{
                field: 'jobStatus',
                title: '状态',
                formatter: function(value, row, index){
                    if(row['jobStatus']==0)
                        return '<p class="text-success">运行</p>';
                    if(row['jobStatus']==1)
                        return '完成';
                    if(row['jobStatus']==2)
                        return '<p class="text-danger">暂停</p>';
                    return value;
                }
            },{
                field: 'operation',
                title: '操作',
                align: 'center',
                formatter: function(value, row, index){

                    return  '<button id="jobDescription" class="btn btn-xs btn-default" onclick="jobDescription('+row.id+')" >任务信息</a> '
                    + '<button id="triggerJob" class="btn btn-xs btn-primary" onclick="triggerJob('+row.id+')" style="margin-left:8px">触发</a> '
                    + '<button id="pauseJob" class="btn btn-xs btn-info" onclick="pauseJob('+row.id+')" style="margin-left:8px">暂停</a> '
                    + '<button id="resumeJob" class="btn btn-xs btn-info" onclick="resumeJob('+row.id+')" style="margin-left:8px">恢复</a>'
                    + '<button type="button" id="editJob" class="btn btn-xs btn-success"  onclick="editJob('+row.id+')" style="margin-left:10px">编辑</a>'
                    + '<button type="button" id="deleteJob" class="btn btn-xs btn-warning" onclick="deleteById('+row.id+')" style="margin-left:10px">删除</a>';
                }
            }],

        });

        function resetAddModal(){
		    document.getElementById("addJobForm").reset();
	    }

        function addJob(){
            var param = $("#addJobForm").serializeArray();
            $.ajax({
                url:"/job/addJob",
                method: "post",
                data:param,
                dataType:"text",
                success:function(data){
                    if(data=="success"){
                        $('#addJobModal').modal('hide');
                        document.getElementById("addJobForm").reset();
                        alert("添加成功");
                        $('#table').bootstrapTable('refresh','/job/jobInfo');
                    }else if(data=="failed"){
                        $('#addJobModal').modal('hide');
                        document.getElementById("addJobForm").reset();
                        alert("添加失败");
                    }else{
                        $('#addJobModal').modal('hide');
                        document.getElementById("addJobForm").reset();
                        alert("执行器已离线！请更换执行器。");
                    }
                }
            });
        }

        function deleteById(id){
            $("#deleteJob").attr("onclick", "deleteById");
            $.ajax({
                url:"/job/deleteJob",
                dataType:"text",
                method:"post",
                data:{
                    "id":id
                },
                success:function(data){
                    if(data=="success"){
                        alert("删除成功");
                        $('#table').bootstrapTable('refresh','/job/jobInfo');
                    }else if(data=="failed"){
                        alert("删除失败");
                    }else{
                        alert("执行器已离线！请更换执行器。");
                    }
                }
            });
        }

        function editJob(id){

            var row = $('#table').bootstrapTable('getRowByUniqueId', id);
            $('#id').val(row.id);
            $('#editJobName').val(row.jobName);
            $('#editJobGroup').val(row.jobGroup);
            $('#editJobCron').val(row.jobCron);
            $('#editJobDesc').val(row.jobDesc);
            $('#editJobFilePath').val(row.jobFilePath);
            $('#editJobFileType').val(row.jobFileType);
            $('#editAuthor').val(row.author);
            $('#editEmail').val(row.email);

            $('#editJobModal').modal('show');
	    }

	    function updateJob(){
            var param = $("#editJobForm").serializeArray();

            $.ajax({
                url:"/job/updateJob",
                method: "post",
                data:param,
                dataType:"text",
                success:function(data){
                    if(data=="success"){
                        alert("更新成功");
                        $('#editJobModal').modal('hide');
                        $('#table').bootstrapTable('refresh','/job/jobInfo');
                    }else if(data=="failed"){
                        alert("更新失败");
                        $('#editJobModal').modal('hide');
                    }else{
                        alert("执行器已离线！请更换执行器。");
                        $('#editJobModal').modal('hide');
                    }
                }
            });
        }

        function pauseJob(id){

            $.ajax({
                url:"/job/pauseJob",
                method: "post",
                dataType: "text",
                data: {"id": id},
                success: function(data){
                    if(data=="success"){
                        document.getElementById('tipContent').innerText="任务暂停！";
                        $('#tip').modal('show');
                        $('#table').bootstrapTable('refresh', '/job/jobInfo');
                    }else if(data=="failed"){
                        document.getElementById('tipContent').innerText="任务暂停失败！";
                        $('#tip').modal('show');
                    }else{
                        document.getElementById('tipContent').innerText="执行器已离线！请更换执行器";
                        $('#tip').modal('show');
                    }
                }
            });
        }

        function resumeJob(id){

            $.ajax({
                url:"/job/resumeJob",
                method: "post",
                dataType: "text",
                data: {"id": id},
                success: function(data){
                    if(data=="success"){
                        document.getElementById('tipContent').innerText="任务执行！";
                        $('#tip').modal('show');
                        $('#table').bootstrapTable('refresh', '/job/jobInfo');
                    }else if(data=="failed"){
                        document.getElementById('tipContent').innerText="任务执行失败！";
                        $('#tip').modal('show');
                    }else{
                        document.getElementById('tipContent').innerText="执行器已离线！请更换执行器！";
                        $('#tip').modal('show');
                    }
                }
            });
        }

        function triggerJob(id){

            $.ajax({
                url:"/job/triggerJob",
                method: "post",
                dataType: "text",
                data: {"id": id},
                success: function(data){
                    if(data=="success"){
                        document.getElementById('tipContent').innerText="任务触发成功！";
                        $('#tip').modal('show');
                        $('#table').bootstrapTable('refresh', '/job/jobInfo');
                    }else if(data=="failed"){
                        document.getElementById('tipContent').innerText="任务触发失败！";
                        $('#tip').modal('show');
                    }else{
                        document.getElementById('tipContent').innerText="执行器已离线！请更换执行器！";
                        $('#tip').modal('show');
                    }
                }
            });
        }

        function jobDescription(id){

            var row = $('#table').bootstrapTable('getRowByUniqueId', id);
            $('#id').val(row.id);
            $('#showJobName').val(row.jobName);
            $('#showJobGroup').val(row.jobGroup);
            $('#showJobCron').val(row.jobCron);
            $('#showJobDesc').val(row.jobDesc);
            $('#showJobFilePath').val(row.jobFilePath);
            $('#showJobFileType').val(row.jobFileType);
            $('#showAuthor').val(row.author);
            $('#showEmail').val(row.email);
            $('#showAddTime').val(row.addTime);
            $('#showUpdateTime').val(row.updateTime);

            $('#showJob').modal('show');
	    }

</script>

<!-- Placed js at the end of the document so the pages load faster -->
<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
<script src="js/jquery-migrate-1.2.1.min.js"></script>

<script src="js/modernizr.min.js"></script>
<script src="js/jquery.nicescroll.js"></script>

<script src="js/bootstrap-select.js"></script>

<script src="js/scripts.js"></script>

</body>

</html>
